# 레거시 코드 리팩터링

## 4단계 - 멀티 모듈 적용

### 요구 사항
- Gradle의 멀티 모듈 개념을 적용해 자유롭게 서로 다른 프로젝트로 분리해 본다.
  - 컨텍스트 간의 독립된 모듈로 만들 수 있다.
  - 계층 간의 독립된 모듈로 만들 수 있다.
- 의존성 주입, HTTP 요청/응답, 이벤트 발행/구독 등 다양한 방식으로 모듈 간 데이터를 주고받을 수 있다.

### 리팩터링
- [x] 멀티 모듈로 분리
  - 컨텍스트 간의 독립된 모듈로 분리
    - 공통 모듈: common-module
    - 상품 모듈: product-module
    - 메뉴 모듈: menu-module
    - 테이블 모듈: table-module
    - 주문 모듈: order-module
  - 모든 모듈들은 공통 모듈에만 의존
    - 공통 모듈에 gradle java-test-fixtures 플러그인 추가해서 테스트 클래스 공유
  - 하나의 모듈 안에서는 도메인 객체 참조 사용
- [x] HTTP 요청/응답
  - 메뉴 -> 상품
    - 메뉴 등록 시 상품 모듈에 HTTP 요청해서 상품의 아이디, 이름, 가격을 응답 받아서 유효성 확인
  - 주문 -> 메뉴
    - 주문 시점의 메뉴 정보를 저장하기 위해 HTTP 요청/응답으로 주문 메뉴의 정보 저장
- [x] 이벤트 발행/구독
  - spring-kafka 의존성 추가
  - 이 프로젝트에서는 도메인 이벤트 발생 시 다른 모듈에서 유효성을 확인하고 정상/예외 결과에 따라 후처리를 해야하는 케이스만 존재 -> 이벤트 발행처가 이벤트 구독자의 어떤 행위에 관심을 가짐 -> 외부 시스템에 논리적인 의존 관계가 존재
    - HTTP 요청/응답으로 구현하면 시스템 간 강한 결합을 가짐
    - 이벤트 발행/구독으로 시스템 간 결합을 느슨하게 만듬
    - ZERO-PAYLOAD 방식을 사용해서 외부 이벤트에 부가 데이터를 전달해서 이벤트의 순서에 대한 보장 문제를 해결하고 페이로드에 외부 시스템에 대한 의존을 제거하여 느슨한 결합을 만듬
    - 도메인에 이벤트가 발생하면 내부 이벤트를 발행하고 내부 이벤트에서 외부 이벤트를 발행하도록 구현
  - 주문 생성 이벤트
    - 이벤트 발행처: 주문
      - ReplyingKafkaTemplate 사용해서 json 메시지로 요청하고 RequestReplyFuture 비동기 결과를 응답 받음
    - 이벤트 구독자: 테이블
  - 테이블 빈 테이블 여부 변경 이벤트
    - 이벤트 발행처: 테이블
    - 이벤트 구독자: 주문
      - 주문 상태가 미완료인 경우 메시지 발행
  - 테이블의 주문 미완료
    - 이벤트 발행처: 주문
    - 이벤트 구독자: 테이블
      - 테이블 빈 테이블 여부 변경 취소
  - 단체 지정 해제 이벤트
    - 이벤트 발행처: 테이블
    - 이벤트 구독자: 주문
      - 주문 상태가 미완료인 경우 메시지 발행
  - 단체 지정 테이블들의 주문 미완료
    - 이벤트 발행처: 주문
    - 이벤트 구독자: 테이블
      - 단체 지정 해제 취소
- [x] JPA open-in-view false 적용
